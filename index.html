<html>
<head>
<title>HP-15C</title>
<style type="text/css">
    #stack {
        float: right;
    }
    #reg {
        clear: right;
        float: right;
    }
    #frame {
        position: relative;
    }
    #calc {
        position: absolute;
        left: 0;
        top: 0;
    }
    #press {
        position: absolute;
        width: 39;
        height: 34;
        overflow: hidden;
        display: none;
    }
    #presskey {
        position: absolute;
    }
    .lcd {
        position: absolute;
        display: none;
    }
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
<script type="text/javascript">
//<![CDATA[
    var Digits = [];
    var Stack = [0, 0, 0, 0];
    var LastX = 0;
    var Reg = new Array(10);
    var Entry;
    var DigitEntry = false;
    var NewDigitEntry;
    var StackLift = false;
    var OldStackLift, NewStackLift;
    var Shift = 0;
    var Prefix;
    var MouseDown = false;

    var CharTable = {
        ' ': [function() {}, function() {}, function() {}],
        'q': [op_sqrt, op_A, op_x2],
        'E': [op_ex, op_B, op_ln],
        ')': [op_10x, op_C, op_log],
        '^': [op_yx, op_D, op_pct],
        '?': [op_1x, op_E, op_dpct],
        '_': [op_chs, op_matrix, op_abs],
        '7': [function() { op_input('7'); }, op_fix, op_deg],
        '8': [function() { op_input('8'); }, op_sci, op_rad],
        '9': [function() { op_input('9'); }, op_eng, op_grd],
        '/': [op_div, op_solve, op_le],
        '': [op_sst, op_lbl, op_bst],
        'T': [op_gto, op_hyp, op_ahyp],
        's': [op_sin, op_dim, op_asin],
        'c': [op_cos, op_index, op_acos],
        't': [op_tan, op_I, op_atan],
        'e': [op_eex, op_result, op_pi],
        '4': [function() { op_input('4'); }, op_xchg, op_sf],
        '5': [function() { op_input('5'); }, op_dse, op_cf],
        '6': [function() { op_input('6'); }, op_isg, op_ftest],
        '*': [op_mul, op_integrate, op_eq],
        '': [op_rs, op_pse, op_pr],
        'G': [op_gsb, op_clear_stat, op_rtn],
        'r': [op_roll, op_clear_prgm, op_rollup],
        'x': [op_xy, op_clear_reg, op_rnd],
        '\b': [op_back, op_clear_prefix, op_clx],
        '\r': [op_enter, op_rand, op_lastx],
        '1': [function() { op_input('1'); }, op_to_r, op_to_p],
        '2': [function() { op_input('2'); }, op_to_hms, op_to_h],
        '3': [function() { op_input('3'); }, op_to_rad, op_to_deg],
        '-': [op_sub, op_re_im, op_test],
        '': [op_on, op_on, op_on],
        'f': [op_f, op_f, op_f],
        'g': [op_g, op_g, op_g],
        'S': [op_sto, op_frac, op_int],
        'R': [op_rcl, op_user, op_mem],
        '0': [function() { op_input('0'); }, op_fact, op_mean],
        '.': [function() { op_input('.'); }, op_yhat, op_s],
        ';': [op_sum, op_lr, op_sumsub],
        '+': [op_add, op_Pyx, op_Cyx],
        '!': op_fact,
        '@': op_x2,
        'a': op_abs,
        'i': op_int,
        'l': op_ln,
        'p': op_pi,
        '\x12': op_rand
    };

    var KeyTable = [
        ['q', 'E', ')', '^', '?', '_', '7', '8', '9', '/'],
        [' ', 'T', 's', 'c', 't', 'e', '4', '5', '6', '*'],
        [' ', 'G', 'r', 'x', '\b','\r','1', '2', '3', '-'],
        [' ', 'f', 'g', 'S', 'R', '\r','0', '.', ';', '+']
    ];

    function update_display() {
        if (DigitEntry) {
            Stack[0] = Number(Entry);
        }
        for (var i = 0; i < 4; i++) {
            $("#stack_" + i).val(Stack[i]);
        }
        $("#last_x").val(LastX);
        for (var i = 0; i < 10; i++) {
            $("#reg_" + i).val(Reg[i]);
        }
        for (var i in Digits) {
            Digits[i].css("display", "none");
        }
        var decimal = $("#decimal");
        var neg = $("#neg");
        decimal.css("display", "none");
        neg.css("display", "none");
        var s = String(Stack[0]);
        var d = 0;
        for (var i = 0; i < s.length; i++) {
            var c = s.charAt(i);
            if (c >= '0' && c <= '9') {
                Digits[d].attr("src", c+".png");
                Digits[d].css("display", "inline");
                d++;
            } else if (c === '.') {
                decimal.css("left", 169 + d * 27);
                decimal.css("top", 91);
                decimal.css("display", "inline");
            } else if (c === '-') {
                neg.css("display", "inline");
            }
        }
    }

    function push(x, forcelift) {
        if (forcelift || StackLift) {
            Stack[3] = Stack[2];
            Stack[2] = Stack[1];
            Stack[1] = Stack[0];
        }
        Stack[0] = x;
        StackLift = true;
    }

    function unop(f) {
        LastX = Stack[0];
        Stack[0] = f(Stack[0]);
    }

    function binop(f) {
        LastX = Stack[0];
        Stack[0] = f(Stack[1], Stack[0]);
        Stack[1] = Stack[2];
        Stack[2] = Stack[3];
    }

    function op_sqrt() {
        unop(Math.sqrt);
    }

    function op_A() {
        alert("Unimplemented: A");
    }

    function op_x2() {
        unop(function(x) { return x * x; });
    }
    
    function op_ex() {
        unop(Math.exp);
    }

    function op_B() {
        alert("Unimplemented: B");
    }

    function op_ln() {
        unop(Math.log);
    }

    function op_10x() {
        unop(function(x) { return Math.pow(10, x); });
    }

    function op_C() {
        alert("Unimplemented: C");
    }

    function op_log() {
        unop(function(x) { return Math.log(x) / Math.log(10); });
    }

    function op_yx() {
        binop(Math.pow);
    }

    function op_D() {
        alert("Unimplemented: D");
    }

    function op_pct() {
        LastX = Stack[0];
        Stack[0] = Stack[1] * Stack[0] / 100;
    }

    function op_1x() {
        unop(function(x) { return 1 / x; });
    }

    function op_E() {
        alert("Unimplemented: E");
    }

    function op_dpct() {
        binop(function(y, x) {
            return (x - y) / y * 100;
        });
    }

    function op_chs() {
        if (DigitEntry) {
            if (Entry.charAt(0) === '-') {
                Entry = Entry.substr(1);
            } else {
                Entry = '-' + Entry;
            }
            NewDigitEntry = true;
        } else {
            Stack[0] = -Stack[0];
        }
    }

    function op_matrix() {
        alert("Unimplemented: MATRIX");
    }

    function op_abs() {
        unop(Math.abs);
    }

    function op_fix() {
        alert("Unimplemented: FIX");
        StackLift = OldStackLift;
    }

    function op_deg() {
        alert("Unimplemented: DEG");
        StackLift = OldStackLift;
    }

    function op_sci() {
        alert("Unimplemented: SCI");
        StackLift = OldStackLift;
    }

    function op_rad() {
        alert("Unimplemented: RAD");
        StackLift = OldStackLift;
    }

    function op_eng() {
        alert("Unimplemented: ENG");
        StackLift = OldStackLift;
    }

    function op_grd() {
        alert("Unimplemented: GRD");
        StackLift = OldStackLift;
    }

    function op_div() {
        binop(function(y, x) { return y / x; });
    }

    function op_solve() {
        alert("Unimplemented: SOLVE");
    }

    function op_le() {
        alert("Unimplemented: x\u2264y");
    }

    function op_sst() {
        alert("Unimplemented: SST");
        StackLift = OldStackLift;
    }

    function op_lbl() {
        alert("Unimplemented: LBL");
    }

    function op_bst() {
        alert("Unimplemented: BST");
        StackLift = OldStackLift;
    }

    function op_gto() {
        alert("Unimplemented: GTO");
    }

    function op_hyp() {
        Prefix = function(k) {
            switch (k) {
                case 's':
                    unop(function(x) {
                        return (Math.exp(x) - Math.exp(-x)) / 2;
                    });
                    break;
                case 'c':
                    unop(function(x) {
                        return (Math.exp(x) + Math.exp(-x)) / 2;
                    });
                    break;
                case 't':
                    unop(function(x) {
                        return (Math.exp(2*x) - 1) / (Math.exp(2*x) + 1);
                    });
                    break;
            }
            Prefix = null;
        };
    }

    function op_ahyp() {
        Prefix = function(k) {
            switch (k) {
                case 's':
                    unop(function(x) {
                        return Math.log(x + Math.sqrt(x*x + 1));
                    });
                    break;
                case 'c':
                    unop(function(x) {
                        return Math.log(x + Math.sqrt(x*x - 1));
                    });
                    break;
                case 't':
                    unop(function(x) {
                        return Math.log((1 + x) / (1 - x)) / 2;
                    });
                    break;
            }
            Prefix = null;
        };
    }

    function op_sin() {
        unop(Math.sin);
    }

    function op_dim() {
        alert("Unimplemented: DIM");
    }

    function op_asin() {
        unop(Math.asin);
    }

    function op_cos() {
        unop(Math.cos);
    }

    function op_index() {
        alert("Unimplemented: (i)");
        StackLift = OldStackLift;
    }

    function op_acos() {
        unop(Math.acos);
    }

    function op_tan() {
        unop(Math.tan);
    }

    function op_I() {
        alert("Unimplemented: I");
    }

    function op_atan() {
        unop(Math.atan);
    }

    function op_eex() {
        op_input('e');
    }

    function op_result() {
        alert("Unimplemented: RESULT");
    }

    function op_pi() {
        push(Math.PI);
    }

    function op_xchg() {
        alert("Unimplemented: x\u2277");
    }

    function op_sf() {
        alert("Unimplemented: SF");
    }

    function op_dse() {
        alert("Unimplemented: DSE");
    }

    function op_cf() {
        alert("Unimplemented: CF");
    }

    function op_isg() {
        alert("Unimplemented: ISG");
    }

    function op_ftest() {
        alert("Unimplemented: F?");
    }

    function op_mul() {
        binop(function(y, x) { return y * x; });
    }

    function op_integrate() {
        alert("Unimplemented: \u222bxy");
    }

    function op_eq() {
        alert("Unimplemented: x=0");
    }

    function op_rs() {
        alert("Unimplemented: R/S");
        StackLift = OldStackLift;
    }

    function op_pse() {
        alert("Unimplemented: PSE");
        StackLift = OldStackLift;
    }

    function op_pr() {
        alert("Unimplemented: P/R");
        StackLift = OldStackLift;
    }

    function op_gsb() {
        alert("Unimplemented: GSB");
    }

    function op_clear_stat() {
        for (var i in Stack) {
            Stack[i] = 0;
        }
        for (var i = 2; i <= 7; i++) {
            Reg[i] = 0;
        }
        StackLift = OldStackLift;
    }

    function op_rtn() {
        alert("Unimplemented: RTN");
    }

    function op_roll() {
        var t = Stack[0];
        Stack[0] = Stack[1];
        Stack[1] = Stack[2];
        Stack[2] = Stack[3];
        Stack[3] = t;
    }

    function op_clear_prgm() {
        alert("Unimplemented: CLEAR PRGM");
    }

    function op_rollup() {
        var t = Stack[3];
        Stack[3] = Stack[2];
        Stack[2] = Stack[1];
        Stack[1] = Stack[0];
        Stack[0] = t;
    }

    function op_xy() {
        var t = Stack[0];
        Stack[0] = Stack[1];
        Stack[1] = t;
    }

    function op_clear_reg() {
        for (var i in Reg) {
            Reg[i] = 0;
        }
        StackLift = OldStackLift;
    }

    function op_rnd() {
        LastX = Stack[0];
        alert("Unimplemented: RND");
    }

    function op_back() {
        if (DigitEntry && Entry.length > 0) {
            Entry = Entry.substr(0, Entry.length-1);
        } else {
            op_clx();
            Entry = "";
        }
        NewDigitEntry = true;
    }

    function op_clear_prefix() {
        alert("Unimplemented: CLEAR PREFIX");
        StackLift = OldStackLift;
    }

    function op_clx() {
        Stack[0] = 0;
        NewStackLift = false;
    }

    function op_enter() {
        push(Stack[0], true);
        NewStackLift = false;
    }

    function op_rand() {
        push(Math.random());
    }

    function op_lastx() {
        push(LastX);
    }

    function op_to_r() {
        LastX = Stack[0];
        var t = Stack[1];
        var r = Stack[0];
        Stack[1] = r * Math.sin(t);
        Stack[0] = r * Math.cos(t);
    }

    function op_to_p() {
        LastX = Stack[0];
        var y = Stack[1];
        var x = Stack[0];
        Stack[1] = Math.atan2(y, x);
        Stack[0] = Math.sqrt(x*x + y*y);
    }

    function op_to_hms() {
        unop(function(x) {
            var r = Math.floor(x);
            x -= r;
            x *= 60;
            r += Math.floor(x) / 100;
            x -= Math.floor(x);
            x *= 60;
            r += x / 10000;
            return r;
        });
    }

    function op_to_h() {
        unop(function(x) {
            var r = Math.floor(x);
            x -= Math.floor(x);
            x *= 100;
            r += Math.floor(x) / 60;
            x -= Math.floor(x);
            x *= 100;
            r += x / 3600;
            return r;
        });
    }

    function op_to_rad() {
        unop(function(x) { return x * Math.PI / 180; });
    }

    function op_to_deg() {
        unop(function(x) { return x * 180 / Math.PI; });
    }

    function op_sub() {
        binop(function(y, x) { return y - x; });
    }

    function op_re_im() {
        alert("Unimplemented: Re\u2277Im");
    }

    function op_test() {
        alert("Unimplemented: TEST");
    }

    function op_on() {
        alert("Unimplemented: ON");
    }

    function op_f() {
        Shift = 1;
    }

    function op_g() {
        Shift = 2;
    }

    function op_sto() {
        Prefix = function(k) {
            if (k >= '0' && k <= '9') {
                Reg[Number(k)] = Stack[0];
            } else if (k === '+' || k === '-' || k === '*' || k === '/') {
                alert("Unimplemented: STO " + k);
            }
            Prefix = null;
        };
    }

    function op_frac() {
        unop(function(x) { x - Math.floor(x); });
    }

    function op_int() {
        unop(Math.floor);
    }

    function op_rcl() {
        Prefix = function(k) {
            if (k >= '0' && k <= '9') {
                push(Reg[Number(k)]);
            } else if (k === '+' || k === '-' || k === '*' || k === '/') {
                alert("Unimplemented: RCL " + k);
            }
            Prefix = null;
        };
    }

    function op_user() {
        alert("Unimplemented: USER");
        StackLift = OldStackLift;
    }

    function op_mem() {
        alert("Unimplemented: MEM");
        StackLift = OldStackLift;
    }

    function op_fact() {
        unop(function(x) {
            var r = 1;
            while (x > 1) {
                r *= x;
                x -= 1;
            }
            return r;
        });
    }

    function op_mean() {
        push(Reg[5] / Reg[2]);
        push(Reg[3] / Reg[2]);
    }

    function op_yhat() {
        LastX = Stack[0];
        var M = Reg[2] * Reg[4] - Reg[3] * Reg[3];
        var N = Reg[2] * Reg[6] - Reg[5] * Reg[5];
        var P = Reg[2] * Reg[7] - Reg[3] * Reg[5];
        push(P / Math.sqrt(M * N));
        push((M * Reg[5] + P * (Reg[2] * LastX - Reg[3])) / (Reg[2] * M));
    }

    function op_s() {
        var M = Reg[2] * Reg[4] - Reg[3] * Reg[3];
        var N = Reg[2] * Reg[6] - Reg[5] * Reg[5];
        push(Math.sqrt(N / (Reg[2] * (Reg[2] - 1))));
        push(Math.sqrt(M / (Reg[2] * (Reg[2] - 1))));
    }

    function op_sum() {
        LastX = Stack[0];
        Reg[2] += 1;
        Reg[3] += Stack[0];
        Reg[4] += Stack[0] * Stack[0];
        Reg[5] += Stack[1];
        Reg[6] += Stack[1] * Stack[1];
        Reg[7] += Stack[0] * Stack[1];
        NewStackLift = false;
    }

    function op_lr() {
        var M = Reg[2] * Reg[4] - Reg[3] * Reg[3];
        var N = Reg[2] * Reg[6] - Reg[5] * Reg[5];
        var P = Reg[2] * Reg[7] - Reg[3] * Reg[5];
        push(P / M);
        push((M * Reg[5] - P * Reg[3]) / (Reg[2] * M));
    }

    function op_sumsub() {
        LastX = Stack[0];
        Reg[2] -= 1;
        Reg[3] -= Stack[0];
        Reg[4] -= Stack[0] * Stack[0];
        Reg[5] -= Stack[1];
        Reg[6] -= Stack[1] * Stack[1];
        Reg[7] -= Stack[0] * Stack[1];
        NewStackLift = false;
    }

    function op_add() {
        binop(function(y, x) { return y + x; });
    }

    function op_Pyx() {
        binop(function(y, x) {
            var r = 1;
            var t = y - x;
            while (y > t) {
                r *= y;
                y--;
            }
            return r;
        });
    }

    function op_Cyx() {
        binop(function(y, x) {
            var r = 1;
            var t = y - x;
            while (y > t) {
                r *= y;
                y--;
            }
            while (x > 1) {
                r /= x;
                x--;
            }
            return r;
        });
    }

    function op_input(c) {
        if (!DigitEntry) {
            if (StackLift) {
                push("");
            }
            Entry = "";
        }
        Entry = Entry + c;
        NewDigitEntry = true;
    }

    function key(k) {
        var s = Shift;
        Shift = -1;
        OldStackLift = StackLift;
        NewDigitEntry = false;
        NewStackLift = true;
        if (Prefix != null) {
            Prefix(k);
        } else if (jQuery.isArray(CharTable[k])) {
            CharTable[k][s]();
        } else {
            CharTable[k]();
        }
        if (Shift === -1) {
            Shift = 0;
        }
        DigitEntry = NewDigitEntry;
        StackLift = NewStackLift;
        update_display();
    }

    $(document).ready(function() {
        for (var i = 0; i < Reg.length; i++) {
            Reg[i] = 0;
        }
        for (var i = 0; i < 10; i++) {
            var d = $("#dig"+i);
            d.css("left", 175 + i * 27);
            d.css("top", 67);
            Digits[Digits.length] = d;
        }
        var neg = $("#neg");
        neg.css("left", 158);
        neg.css("top", 80);
        $("#calc").mousedown(function(e) {
            var calc = $("#calc");
            var x = e.clientX - calc.offset().left;
            var y = e.clientY - calc.offset().top;
            if (x >= 65 && x < 645 && y >= 155 && y < 405) {
                var c = Math.floor((x - 65) / 57);
                var r = Math.floor((y - 155) / 65);
                if (c >= 0 && c < 10 && r >= 0 && r < 4) {
                    MouseDown = true;
                    var keyx = 81 + c * 57;
                    var keyy = 169 + r * 65;
                    var press = $("#press");
                    var presskey = $("#presskey");
                    press.css("left", keyx);
                    press.css("top", keyy);
                    presskey.css("left", -keyx);
                    presskey.css("top", -keyy - 1);
                    press.css("display", "block");
                    key(KeyTable[r][c]);
                }
            }
            e.preventDefault();
        });
        $("#calc").mouseup(function(e) {
            if (MouseDown) {
                $("#press").css("display", "none");
                MouseDown = false;
            }
        });
        $("#press").mouseup(function(e) {
            if (MouseDown) {
                $("#press").css("display", "none");
                MouseDown = false;
            }
        });
        $(document).keypress(function(e) {
            var c = String.fromCharCode(e.which);
            if (c === '\b') {
                e.preventDefault();
            }
            if (CharTable[c]) {
                key(c);
            }
            e.stopPropagation();
        });
        update_display();
    });
//]]>
</script>
</head>
<body>
<h1>HP-15C</h1>
<div id="stack">
<table>
<tr><td align="right">T</td><td><input id="stack_3"></td></tr>
<tr><td align="right">Z</td><td><input id="stack_2"></td></tr>
<tr><td align="right">Y</td><td><input id="stack_1"></td></tr>
<tr><td align="right">X</td><td><input id="stack_0"></td></tr>
<tr><td align="right">LAST X</td><td><input id="last_x"></td></tr>
</table>
</div>
<div id="reg">
<table>
<tr><td>0</td><td><input id="reg_0"></td></tr>
<tr><td>1</td><td><input id="reg_1"></td></tr>
<tr><td>2</td><td><input id="reg_2"></td></tr>
<tr><td>3</td><td><input id="reg_3"></td></tr>
<tr><td>4</td><td><input id="reg_4"></td></tr>
<tr><td>5</td><td><input id="reg_5"></td></tr>
<tr><td>6</td><td><input id="reg_6"></td></tr>
<tr><td>7</td><td><input id="reg_7"></td></tr>
<tr><td>8</td><td><input id="reg_8"></td></tr>
<tr><td>9</td><td><input id="reg_9"></td></tr>
</table>
</div>
<div id="frame">
<img id="calc" src="15.jpg">
<div id="press"><img id="presskey" src="15.jpg"></div>
<img id="dig0" class="lcd" src="0.png">
<img id="dig1" class="lcd" src="1.png">
<img id="dig2" class="lcd" src="2.png">
<img id="dig3" class="lcd" src="3.png">
<img id="dig4" class="lcd" src="4.png">
<img id="dig5" class="lcd" src="5.png">
<img id="dig6" class="lcd" src="6.png">
<img id="dig7" class="lcd" src="7.png">
<img id="dig8" class="lcd" src="8.png">
<img id="dig9" class="lcd" src="9.png">
<img id="decimal" class="lcd" src="decimal.png">
<img id="neg" class="lcd" src="neg.png">
</div>
</body>
</html>
